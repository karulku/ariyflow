C51 COMPILER V9.54   STACK                                                                 11/05/2025 21:28:58 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE STACK
OBJECT MODULE PLACED IN .\Objects\stack.obj
COMPILER INVOKED BY: D:\0_SoftWare\Keil5\C51\BIN\C51.EXE src\stack.c LARGE OMF2 OPTIMIZE(0,SPEED) BROWSE DEBUG PRINT(.\L
                    -istings\stack.lst) TABS(2) OBJECT(.\Objects\stack.obj)

line level    source

   1          #include "stack.h"
   2          
   3          IDATA u8 kernel_stack[KERNEL_STACKSIZE];
   4          IDATA u8 process_stack[5][PROCESS_STACKSIZE];
   5          XDATA u8 process_stack_swap[3][PROCESS_STACKSIZE];
   6          
   7          /*
   8              OS allows 8 processes maximum, but there are only
   9              5 process stacks allowed in memory due to size 
  10              limitations.
  11              
  12              the process stacks can be swapped out to xdata 
  13              swap area if there are more than 5 processes at
  14              the same time.
  15          */
  16          
  17          char get_stack_index(u8 pid)
  18          {
  19   1        XDATA u8 i;
  20   1        for(i=0;i<5;i++)
  21   1          if(process_stack[i][PROCESS_STACKSIZE-1] == pid)
  22   1            return i;
  23   1        
  24   1        return -1;
  25   1      }
  26          
  27          char get_stackswap_index(u8 pid)
  28          {
  29   1        XDATA u8 i;
  30   1        for(i=0;i<3;i++)
  31   1          if(process_stack_swap[i][PROCESS_STACKSIZE-1] == pid)
  32   1            return i;
  33   1        
  34   1        return -1;
  35   1      }
  36          
  37          
  38          extern XDATA u8 process_context[8][18];
  39          extern XDATA u8 process_slot;
  40          void stackswap(u8 swap_index)
  41          {
  42   1        XDATA u8 i, temp, physical_index;
  43   1        
  44   1        //first try to find a stack slot that's not being used
  45   1        physical_index = 0xff;
  46   1        for(i=0;i<5;i++)
  47   1        {
  48   2          if(process_slot & BIT(process_stack[i][PROCESS_STACKSIZE-1]) == 0)
  49   2          {
  50   3            physical_index = i;
  51   3            break;
  52   3          }
  53   2        }
  54   1        
C51 COMPILER V9.54   STACK                                                                 11/05/2025 21:28:58 PAGE 2   

  55   1        //if there's no free stack slot, select random victim
  56   1        physical_index = rand32()%5;
  57   1        
  58   1        for(i=0; i<PROCESS_STACKSIZE; i++)
  59   1        {
  60   2          temp = process_stack[physical_index][i];
  61   2          process_stack[physical_index][i] = process_stack_swap[swap_index][i];
  62   2          process_stack_swap[swap_index][i] = temp;
  63   2        }
  64   1        
  65   1        //convert context SP of process whose stack is being swapped out to a relative address
  66   1        process_context[process_stack_swap[swap_index][PROCESS_STACKSIZE-1]][17] -= (u8)process_stack[physical_in
             -dex];
  67   1        
  68   1        //convert context SP of process whose stack is being swapped in to an absolute address
  69   1        process_context[process_stack[physical_index][PROCESS_STACKSIZE-1]][17] += (u8)process_stack[physical_in
             -dex];
  70   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    521    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     71    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =    120    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
